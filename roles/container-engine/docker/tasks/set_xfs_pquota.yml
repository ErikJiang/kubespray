---

# https://docs.docker.com/reference/cli/dockerd/#overlay2-options

- name: Stop if `docker_mount_device` is not defined or `docker_mount_device` is empty
  assert:
    that:
    - docker_mount_device is defined
    - docker_mount_device != ""
    msg: >
      When configuring overlay2.size in `docker_storage_options`, `docker_mount_device` needs to be set.
  when: "'overlay2.size' in docker_storage_options"

- name: Get device mount info
  shell: lsblk -n -o MOUNTPOINT {{ docker_mount_device }}
  register: mount_info
  changed_when: false
  failed_when: false
  when: "'overlay2.size' in docker_storage_options"

- name: debug
  debug:
    msg: "mount_info: {{ mount_info }}"
  when: "'overlay2.size' in docker_storage_options"

- name: Stop if the device is already mounted and in use
  assert:
    that:
    - mount_info.stdout_lines | length == 0
    - mount_info.stderr_lines | length == 0
    msg: >
      {{ docker_mount_device }} is already mounted and in use, or it is not a block device.
  when: "'overlay2.size' in docker_storage_options"

- name: "Create a xfs filesystem on {{ docker_mount_device }}"
  community.general.filesystem:
    fstype: xfs
    dev: "{{ docker_mount_device }}"
  when: "'overlay2.size' in docker_storage_options"

- name: Mount up xfs device with pquota option
  mount:
    path: "{{ docker_daemon_graph }}"
    src: "{{ docker_mount_device }}"
    fstype: xfs
    opts: pquota
    state: mounted
  when: "'overlay2.size' in docker_storage_options"
